# Dapr Agents - Demonstrating Tool Format Error with OpenAI

This repository demonstrates a bug in the `dapr-agents` library where configuring an Agent with any tools causes it to send requests to the LLM using the `dapr` format instead of the `openai` format. This occurs even when the `DAPR_LLM_TOOL_FORMAT_DEFAULT` environment variable is explicitly set to `openai`.

This behavior leads to a `FunCallBuilderError: Unsupported format type: dapr` runtime error, preventing the combined use of an OpenAI LLM and dedicated tools (like MCP tools) within the same Agent.

The project uses Chainlit for the UI and demonstrates an interaction with an Agent that is supposed to contact Couchbase via MCP Tools for database queries and OpenAI for general conversation.

## Project Structure

* [cite_start]**`app.py`**: The main Chainlit application[cite: 1]. [cite_start]It initializes the Dapr Agent, loads tools from the MCP, configures the environment, and manages the user chat session[cite: 1].
* [cite_start]**`requirements.txt`**: A list of all the Python dependencies required to run the project[cite: 2].
* **`.env`**: An environment variables file. It contains Dapr default settings, connection details for Couchbase, and the MCP server URL.
* **`/components`**: A directory containing the Dapr component definitions.
    * `openai.yaml`: Defines the `conversation.openai` component for communicating with OpenAI.
    * `conversationmemory.yaml`: Defines a `state.redis` component used by Chainlit to persist conversation history.
* **`schema_context.json`**: (Not included in this repository) A file containing the data schema from the Couchbase database. [cite_start]It needs to be generated by a preliminary script, as noted in `app.py`[cite: 1].

## Prerequisites

* Python 3.8+
* Dapr CLI
* Docker (or a local installation of Redis and Couchbase)
* A running MCP (Multi-Capability Plane) Server instance.

## Installation and Setup

1.  **Clone the repository:**
    ```bash
    git clone <your-repository-url>
    cd <repository-directory>
    ```

2.  **Install dependencies:**
    ```bash
    pip install -r requirements.txt
    ```

3.  **Configure your environment:**
    Create a `.env` file (you can copy the provided example) and fill in the required details:
    * Your OpenAI API key in the `components/openai.yaml` file.
    * Your Couchbase connection details and MCP server URL in the `.env` file.

4.  **Generate the database schema:**
    (If you want to reproduce the full scenario against Couchbase) Run a preliminary script to generate the `schema_context.json` file. [cite_start]As mentioned in `app.py`, this file is essential for the Agent's context[cite: 1].

5.  **Run the application with Dapr:**
    Use the following command to launch the application with a Dapr sidecar:
    ```bash
    dapr run --app-id chat-agent --dapr-http-port 3500 --components-path ./components -- chainlit run app.py -w --port 8001
    ```

## Reproducing the Bug

You can control the Agent's behavior by editing the `app.py` file.

#### Working Scenario (Without Tools)

1.  In `app.py`, ensure the line `tools=tools,` within the `Agent` definition is commented out (`#`).
2.  Run the application.
3.  Open the UI at `http://localhost:8001` and send a general message (e.g., "hello").
4.  **Result:** The Agent will respond successfully. The log will show a valid call to the OpenAI API.

#### Failing Scenario (With Tools)

1.  In `app.py`, uncomment the `tools=tools,` line within the `Agent` definition.
2.  Restart the application.
3.  Send a general message in the UI.
4.  **Result:** The application will crash, and the terminal will display the `FunCallBuilderError: Unsupported format type: dapr` error. This demonstrates that the Agent is ignoring the `DAPR_LLM_TOOL_FORMAT_DEFAULT=openai` setting and using the `dapr` format, which the OpenAI component does not support.
